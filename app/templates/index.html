{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Device Dashboard</h1>
    <div>
      {% if session.logged_in %}
        <a href="{{ url_for('routes.logout') }}" class="btn btn-outline-danger">Logout</a>
      {% else %}
        <a href="{{ url_for('routes.login') }}" class="btn btn-outline-primary">Login</a>
      {% endif %}
    </div>
  </div>

  <!-- Add Device Form (only for logged-in users) -->
  {% if session.logged_in %}
  <form method="post" class="row g-3 mb-4">
    <div class="col-md-3">
      <input name="name" class="form-control" placeholder="Device name" required>
    </div>
    <div class="col-md-4">
      <input name="host" class="form-control" placeholder="Host/IP (or full URL for HTTP)" required>
    </div>
    <div class="col-md-3">
      <select name="kind" class="form-select">
        <option value="icmp" selected>ICMP (ping)</option>
        <option value="http">HTTP (website/API)</option>
        <option value="tcp">TCP Port (e.g., printer 9100)</option>
      </select>
    </div>
    <div class="col-md-1">
      <input name="port" class="form-control" placeholder="Port" type="number" min="1" max="65535">
    </div>
    <div class="col-md-1">
      <button class="btn btn-primary w-100">Add</button>
    </div>
  </form>
  {% endif %}

  <!-- Devices Table -->
  <table class="table table-bordered table-striped align-middle">
    <thead>
      <tr>
        <th>Name</th>
        <th>Host</th>
        <th>Kind</th>
        <th>Status</th>
        <th>Latency (ms)</th>
        <th>Last Check</th>
        {% if session.logged_in %}<th>Actions</th>{% endif %}
      </tr>
    </thead>
    <tbody id="devices-body">
      {% for d in devices %}
      {% set cr = latest.get(d.id) %}
      <tr id="row-{{ d.id }}">
        <td class="c-name">{{ d.name }}</td>
        <td class="c-host">{{ d.host }}</td>
        <td class="c-kind text-uppercase">{{ d.kind }}</td>
        <td class="c-status">
          {% if cr %}
            {% if cr.status == "up" %}
              <span class="badge bg-success">UP</span>
            {% elif cr.status == "degraded" %}
              <span class="badge bg-warning text-dark">DEGRADED</span>
            {% else %}
              <span class="badge bg-danger">DOWN</span>
            {% endif %}
          {% else %}
            <span class="badge bg-secondary">Unknown</span>
          {% endif %}
        </td>
        <td class="c-latency">{{ (cr.latency_ms ~ ' ms') if cr and cr.latency_ms is not none else '-' }}</td>
        <td class="c-last">{{ cr.created_at.strftime('%Y-%m-%d %H:%M:%S') if cr else 'never' }}</td>
        {% if session.logged_in %}
        <td>
          <form method="post" action="{{ url_for('routes.delete_device', device_id=d.id) }}">
            <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this device?')">Delete</button>
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
  // Whether to render Actions column on newly added rows during AJAX updates
  const canDelete = {{ 'true' if session.logged_in else 'false' }};

  function badge(status) {
    if (status === "up")       return '<span class="badge bg-success">UP</span>';
    if (status === "degraded") return '<span class="badge bg-warning text-dark">DEGRADED</span>';
    if (status === "down")     return '<span class="badge bg-danger">DOWN</span>';
    return '<span class="badge bg-secondary">Unknown</span>';
  }

  async function refreshDevices() {
    try {
      const resp = await fetch("{{ url_for('routes.api_devices') }}", { cache: "no-store" });
      if (!resp.ok) return;
      const data = await resp.json();

      const tbody = document.getElementById("devices-body");
      const seen = new Set();

      data.forEach(dev => {
        seen.add(dev.id);
        const row = document.getElementById(`row-${dev.id}`);
        const latency = (dev.latency_ms ?? "-");
        const last = (dev.last_check ?? "never");
        const kind = (dev.kind || "").toUpperCase();

        if (row) {
          row.querySelector(".c-status").innerHTML = badge(dev.status);
          row.querySelector(".c-latency").textContent = (latency === "-" ? "-" : `${latency} ms`);
          row.querySelector(".c-last").textContent = last;
          row.querySelector(".c-kind").textContent = kind;
          row.querySelector(".c-host").textContent = dev.host;
          row.querySelector(".c-name").textContent = dev.name;
        } else {
          // New device appeared: append row
          const tr = document.createElement("tr");
          tr.id = `row-${dev.id}`;
          tr.innerHTML = `
            <td class="c-name">${dev.name}</td>
            <td class="c-host">${dev.host}</td>
            <td class="c-kind text-uppercase">${kind}</td>
            <td class="c-status">${badge(dev.status)}</td>
            <td class="c-latency">${latency === "-" ? "-" : latency + " ms"}</td>
            <td class="c-last">${last}</td>
            ${canDelete ? `
            <td>
              <form method="post" action="/devices/${dev.id}/delete">
                <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this device?')">Delete</button>
              </form>
            </td>` : ``}
          `;
          tbody.appendChild(tr);
        }
      });

      // Remove rows no longer present
      for (const tr of Array.from(tbody.querySelectorAll("tr"))) {
        const id = parseInt(tr.id.replace("row-", ""), 10);
        if (!seen.has(id)) tr.remove();
      }
    } catch (e) {
      console.warn("refreshDevices error:", e);
    }
  }

  // Run immediately, then every 10s (adjust if needed)
  refreshDevices();
  setInterval(refreshDevices, 10000);
  </script>
{% endblock %}
