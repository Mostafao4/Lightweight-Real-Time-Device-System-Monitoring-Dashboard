{% extends "base.html" %}
{% block title %}{{ device.name }} History{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">
    {{ device.name }}
    <small class="text-muted">({{ device.host }} · {{ device.kind|upper }})</small>
  </h2>
  <div>
    <a class="btn btn-outline-secondary" href="{{ url_for('routes.index') }}">← Back</a>
    <a class="btn btn-outline-primary" href="{{ url_for('routes.device_history_csv', device_id=device.id) }}{% if request.query_string %}?{{ request.query_string|safe }}{% endif %}">Export CSV</a>
  </div>
</div>

<!-- Filters -->
<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <label class="form-label">From</label>
    <input type="text" class="form-control" name="from" placeholder="YYYY-MM-DD or ISO" value="{{ request.args.get('from','') }}">
  </div>
  <div class="col-auto">
    <label class="form-label">To</label>
    <input type="text" class="form-control" name="to" placeholder="YYYY-MM-DD or ISO" value="{{ request.args.get('to','') }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Max points</label>
    <input type="number" class="form-control" name="limit" min="50" max="5000" value="{{ request.args.get('limit','200') }}">
  </div>
  <div class="col-auto align-self-end">
    <button class="btn btn-primary">Apply</button>
  </div>
</form>

<!-- Latency chart -->
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">Latency over time</h5>
    <div style="height:400px; width:100%; max-width:1000px;">
      <canvas id="latencyChart"></canvas>
    </div>

    <div class="small text-muted mt-2">
      Non-responding checks (DOWN) have no latency and are omitted from the line. See the table below for full status history.
    </div>
  </div>
</div>

<!-- History table -->
<div class="card">
  <div class="card-body">
    <h5 class="card-title">Check history</h5>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Time</th>
            <th>Status</th>
            <th>Latency</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
          <tr>
            <td class="text-nowrap">{{ r.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
              {% if r.status == 'up' %}
                <span class="badge bg-success">UP</span>
              {% elif r.status == 'degraded' %}
                <span class="badge bg-warning text-dark">DEGRADED</span>
              {% else %}
                <span class="badge bg-danger">DOWN</span>
              {% endif %}
            </td>
            <td>{{ (r.latency_ms ~ ' ms') if r.latency_ms is not none else '-' }}</td>
            <td>{{ r.message or '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Chronological labels and latency values (null when DOWN)
  const labels = [
    {% for r in results_chrono %}
      "{{ r.created_at.strftime('%Y-%m-%d %H:%M:%S') }}",
    {% endfor %}
  ];
  const latencies = [
    {% for r in results_chrono %}
      {{ 'null' if r.latency_ms is none else r.latency_ms }},
    {% endfor %}
  ];
  const statuses = [
    {% for r in results_chrono %}
      "{{ r.status }}",
    {% endfor %}
  ];

  // Build status marker series on a secondary axis (y2 = 0..1)
  const downMarks = statuses.map(s => s === "down" ? 1 : null);
  const degradedMarks = statuses.map(s => s === "degraded" ? 1 : null);

  const ctx = document.getElementById('latencyChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        // 1) Latency line (left axis)
        {
          label: 'Latency (ms)',
          data: latencies,
          spanGaps: true,           // skip nulls but connect line
          tension: 0.25,
          pointRadius: 2,
          fill: false,
          yAxisID: 'y'
        },
        // 2) DOWN markers (right axis 0..1)
        {
          label: 'DOWN',
          data: downMarks,
          type: 'line',
          showLine: false,
          spanGaps: false,
          pointRadius: 5,
          pointHoverRadius: 6,
          borderWidth: 0,
          pointBackgroundColor: 'rgba(220, 53, 69, 1)',   // red
          pointBorderColor: 'rgba(220, 53, 69, 1)',
          yAxisID: 'y2'
        },
        // 3) DEGRADED markers (right axis 0..1)
        {
          label: 'DEGRADED',
          data: degradedMarks,
          type: 'line',
          showLine: false,
          spanGaps: false,
          pointRadius: 5,
          pointHoverRadius: 6,
          borderWidth: 0,
          pointBackgroundColor: 'rgba(255, 193, 7, 1)',   // amber
          pointBorderColor: 'rgba(255, 193, 7, 1)',
          yAxisID: 'y2'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // respect fixed container size
      scales: {
        // Left axis: latency in ms
        y: {
          title: { display: true, text: 'Latency (ms)' },
          beginAtZero: true
        },
        // Right axis: status markers only (0..1), hidden ticks
        y2: {
          position: 'right',
          min: 0, max: 1,
          grid: { display: false },
          ticks: { display: false },
          title: { display: false }
        },
        x: {
          title: { display: true, text: 'Time' }
        }
      },
      plugins: {
        legend: { display: true }
      }
    }
  });
</script>

{% endblock %}
